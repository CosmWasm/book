<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Fixing admin contract - CosmWasm book</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Guide to building CosmWasm smart contracts">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Getting started</li><li class="chapter-item expanded "><a href="../setting-up-env.html"><strong aria-hidden="true">1.</strong> Setting up the environment</a></li><li class="chapter-item expanded "><a href="../wasmd-quick-start.html"><strong aria-hidden="true">2.</strong> Quick start with wasmd</a></li><li class="chapter-item expanded affix "><li class="part-title">Smart contracts</li><li class="chapter-item expanded "><a href="../basics.html"><strong aria-hidden="true">3.</strong> Basics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../basics/rust-project.html"><strong aria-hidden="true">3.1.</strong> Create a Rust project</a></li><li class="chapter-item expanded "><a href="../basics/entry-points.html"><strong aria-hidden="true">3.2.</strong> Entry points</a></li><li class="chapter-item expanded "><a href="../basics/building-contract.html"><strong aria-hidden="true">3.3.</strong> Building the contract</a></li><li class="chapter-item expanded "><a href="../basics/query.html"><strong aria-hidden="true">3.4.</strong> Creating a query</a></li><li class="chapter-item expanded "><a href="../basics/query-testing.html"><strong aria-hidden="true">3.5.</strong> Testing a query</a></li><li class="chapter-item expanded "><a href="../basics/multitest-intro.html"><strong aria-hidden="true">3.6.</strong> Introducing multitest</a></li><li class="chapter-item expanded "><a href="../basics/state.html"><strong aria-hidden="true">3.7.</strong> Contract state</a></li><li class="chapter-item expanded "><a href="../basics/execute.html"><strong aria-hidden="true">3.8.</strong> Execution messages</a></li><li class="chapter-item expanded "><a href="../basics/events.html"><strong aria-hidden="true">3.9.</strong> Events, attributes and data</a></li><li class="chapter-item expanded "><a href="../basics/funds.html"><strong aria-hidden="true">3.10.</strong> Dealing with funds</a></li><li class="chapter-item expanded "><a href="../basics/good-practices.html"><strong aria-hidden="true">3.11.</strong> Good practices</a></li><li class="chapter-item expanded "><a href="../basics/fp-types.html"><strong aria-hidden="true">3.12.</strong> Floating point types</a></li></ol></li><li class="chapter-item expanded "><a href="../actor-model.html"><strong aria-hidden="true">4.</strong> The Actor Model</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../actor-model/idea.html"><strong aria-hidden="true">4.1.</strong> The idea</a></li><li class="chapter-item expanded "><a href="../actor-model/actors-in-blockchain.html"><strong aria-hidden="true">4.2.</strong> Actors in the blockchain</a></li><li class="chapter-item expanded "><a href="../actor-model/contract-as-actor.html"><strong aria-hidden="true">4.3.</strong> Contract as an actor</a></li></ol></li><li class="chapter-item expanded "><a href="../cross-contract.html"><strong aria-hidden="true">5.</strong> Cross contract communication</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cross-contract/design.html"><strong aria-hidden="true">5.1.</strong> Design</a></li><li class="chapter-item expanded "><a href="../cross-contract/fixing-admin.html" class="active"><strong aria-hidden="true">5.2.</strong> Fixing admin contract</a></li><li class="chapter-item expanded "><a href="../cross-contract/map-storage.html"><strong aria-hidden="true">5.3.</strong> Map storage</a></li><li class="chapter-item expanded "><a href="../cross-contract/working-with-time.html"><strong aria-hidden="true">5.4.</strong> Working with time</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Inter-blockchain communication</div></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../impressum.html">Legal Information</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CosmWasm book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="fixing-admin-contract"><a class="header" href="#fixing-admin-contract">Fixing admin contract</a></h1>
<p>Now that we know what we want to achieve, we can start by aligning the
contract we already have to become an admin contract. It is primarily
fine at this point, but we want to do a cleanup.</p>
<h2 id="cleaning-up-queries"><a class="header" href="#cleaning-up-queries">Cleaning up queries</a></h2>
<p>The first thing to do is to get rid of the <code>Greet</code> query - it was good as a
starter query example, but it has no practical purpose and only generates noise.</p>
<p>We want to remove the unnecessary variant from the query enum:</p>
<pre><pre class="playground"><code class="language-rust edition2021">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span><span class="boring">use cosmwasm_schema::{cw_serde, QueryResponses};
</span><span class="boring">use cosmwasm_std::Addr;
</span><span class="boring">
</span><span class="boring">#[cw_serde]
</span><span class="boring">pub struct InstantiateMsg {
</span><span class="boring">    pub admins: Vec&lt;String&gt;,
</span><span class="boring">    pub donation_denom: String,
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">#[cw_serde]
</span><span class="boring">pub enum ExecuteMsg {
</span><span class="boring">    Leave {},
</span><span class="boring">    Donate {},
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">#[cw_serde]
</span><span class="boring">pub struct AdminsListResp {
</span><span class="boring">    pub admins: Vec&lt;Addr&gt;,
</span><span class="boring">}
</span><span class="boring">
</span>#[cw_serde]
#[derive(QueryResponses)]
pub enum QueryMsg {
    #[returns(AdminsListResp)]
    AdminsList {},
}
<span class="boring">}
</span></code></pre></pre>
<p>Then we also remove the invalid path in the query dispatcher:</p>
<pre><pre class="playground"><code class="language-rust edition2021">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn query(deps: Deps, _env: Env, msg: QueryMsg) -&gt; StdResult&lt;Binary&gt; {
    use QueryMsg::*;

    match msg {
        AdminsList {} =&gt; to_binary(&amp;query::admins_list(deps)?),
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>Finally, we remove the irrelevant handler from the <code>contract::query</code> module.
We also need to make sure all references to it are gone (eg. if there are any
in the tests).</p>
<h2 id="generating-the-library-output"><a class="header" href="#generating-the-library-output">Generating the library output</a></h2>
<p>At the very beginning of the book, we set the <code>crate-type</code> in <code>Cargo.toml</code> as
<code>&quot;cdylib&quot;</code>. It was required to generate the wasm output, but it comes with a
drawback - the dynamic libraries, as this cannot be used as dependencies in
other crates. It was not a problem before, but in practice we often want to
depend contract on others to get access to some types of them - for example,
defined messages.</p>
<p>Good for us. It is easy to fix. You might notice that the <code>crate-type</code> is an array,
not a single string. The reason for that is that our project can emit several
targets - in particular, we can add there the default <code>&quot;rlib&quot;</code> crate type to
make it generate a &quot;rust library&quot; output - which is what we need to use as a
dependency. Let's update our <code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[package]
name = &quot;admin&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[lib]
crate-type = [&quot;cdylib&quot;, &quot;rlib&quot;]
# 
# [features]
# library = []
# 
# [dependencies]
# cosmwasm-std = { version = &quot;1.1.4&quot;, features = [&quot;staking&quot;] }
# serde = { version = &quot;1.0.103&quot;, default-features = false, features = [&quot;derive&quot;] }
# cw-storage-plus = &quot;0.15.1&quot;
# thiserror = &quot;1&quot;
# schemars = &quot;0.8.1&quot;
# cw-utils = &quot;0.15.1&quot;
# cosmwasm-schema = &quot;1.1.4&quot;
# 
# [dev-dependencies]
# cw-multi-test = &quot;0.15.1&quot;
</code></pre>
<p>Also, note I changed the contract name - &quot;contract&quot; is not very descriptive, so
I updated it to &quot;admin&quot;.</p>
<h2 id="project-structure"><a class="header" href="#project-structure">Project structure</a></h2>
<p>Last but not least - we want to better structure our project. So far, we have
only one contract, so we just worked on it as a whole project. Now we want some
directory tree that reflects relations between contracts we create.</p>
<p>First, create a directory for the project. Then we want to create a &quot;contracts&quot;
subdirectory in it. It is not technically required from Rust's POV, but there
are tools in our environment, like the workspace optimizer, which would assume
it is where it should look for a contract. It is a common pattern you will see
in CosmWasm contracts repos.</p>
<p>Then we copy the whole project directory from the previous chapter into the
<code>contracts</code>, renaming it to <code>admin</code>.</p>
<p>Finally, we want to couple all our projects (for now, it is just one, but we know
there will be more there). To do so, we create the workspace-level <code>Cargo.toml</code>
file in the top-level project directory:</p>
<pre><code class="language-toml">[workspace]
members = [&quot;contracts/*&quot;]
resolver = &quot;2&quot;
</code></pre>
<p>This <code>Cargo.toml</code> differs slightly from the typical project-level one - it
defines the workspace. The most important field here is the <code>members</code> - it
defines projects being part of the workspace.</p>
<p>The other field is the <code>resolver</code>. It is something to remember to add - it
instructs cargo to use version 2 of the dependency resolver. This has been the
default for non-workspaces since Rust 2021, but because of compatibility reasons,
the default couldn't be changed for workspaces - but it is advised to add it to
every single newly created workspace.</p>
<p>The last field which might be useful for workspaces is exclude - it allows to
create projects in the workspace directory tree, which is not a part of this
workspace - we will not use it, but it is good to know about it.</p>
<p>Now just for clarity, let's see the top-level directory structure:</p>
<pre><code class="language-none">.
├── Cargo.lock
├── Cargo.toml
├── contracts
│  └── admin
└── target
   ├── CACHEDIR.TAG
   └── debug
</code></pre>
<p>You can see the target directory and <code>Cargo.lock</code> files existing in the tree - it is
because I already built and ran tests for the <code>admin</code> contract - in Rust workspaces,
`cargo`` knows to build everything in the top level, even if it would be built from
the inner directory.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../cross-contract/design.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../cross-contract/map-storage.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../cross-contract/design.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../cross-contract/map-storage.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
