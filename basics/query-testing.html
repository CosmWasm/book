<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Testing a query - CosmWasm book</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Guide to building CosmWasm smart contracts">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Getting started</li><li class="chapter-item expanded "><a href="../setting-up-env.html"><strong aria-hidden="true">1.</strong> Setting up the environment</a></li><li class="chapter-item expanded "><a href="../wasmd-quick-start.html"><strong aria-hidden="true">2.</strong> Quick start with wasmd</a></li><li class="chapter-item expanded affix "><li class="part-title">Smart contracts</li><li class="chapter-item expanded "><a href="../basics.html"><strong aria-hidden="true">3.</strong> Basics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../basics/rust-project.html"><strong aria-hidden="true">3.1.</strong> Create a Rust project</a></li><li class="chapter-item expanded "><a href="../basics/entry-points.html"><strong aria-hidden="true">3.2.</strong> Entry points</a></li><li class="chapter-item expanded "><a href="../basics/building-contract.html"><strong aria-hidden="true">3.3.</strong> Building the contract</a></li><li class="chapter-item expanded "><a href="../basics/query.html"><strong aria-hidden="true">3.4.</strong> Creating a query</a></li><li class="chapter-item expanded "><a href="../basics/query-testing.html" class="active"><strong aria-hidden="true">3.5.</strong> Testing a query</a></li><li class="chapter-item expanded "><a href="../basics/multitest-intro.html"><strong aria-hidden="true">3.6.</strong> Introducing multitest</a></li><li class="chapter-item expanded "><a href="../basics/state.html"><strong aria-hidden="true">3.7.</strong> Contract state</a></li><li class="chapter-item expanded "><a href="../basics/execute.html"><strong aria-hidden="true">3.8.</strong> Execution messages</a></li><li class="chapter-item expanded "><a href="../basics/events.html"><strong aria-hidden="true">3.9.</strong> Events, attributes and data</a></li><li class="chapter-item expanded "><a href="../basics/funds.html"><strong aria-hidden="true">3.10.</strong> Dealing with funds</a></li><li class="chapter-item expanded "><a href="../basics/good-practices.html"><strong aria-hidden="true">3.11.</strong> Good practices</a></li><li class="chapter-item expanded "><a href="../basics/fp-types.html"><strong aria-hidden="true">3.12.</strong> Floating point types</a></li></ol></li><li class="chapter-item expanded "><a href="../actor-model.html"><strong aria-hidden="true">4.</strong> The Actor Model</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../actor-model/idea.html"><strong aria-hidden="true">4.1.</strong> The idea</a></li><li class="chapter-item expanded "><a href="../actor-model/actors-in-blockchain.html"><strong aria-hidden="true">4.2.</strong> Actors in the blockchain</a></li><li class="chapter-item expanded "><a href="../actor-model/contract-as-actor.html"><strong aria-hidden="true">4.3.</strong> Contract as an actor</a></li></ol></li><li class="chapter-item expanded "><a href="../cross-contract.html"><strong aria-hidden="true">5.</strong> Cross contract communication</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cross-contract/design.html"><strong aria-hidden="true">5.1.</strong> Design</a></li><li class="chapter-item expanded "><a href="../cross-contract/fixing-admin.html"><strong aria-hidden="true">5.2.</strong> Fixing admin contract</a></li><li class="chapter-item expanded "><a href="../cross-contract/map-storage.html"><strong aria-hidden="true">5.3.</strong> Map storage</a></li><li class="chapter-item expanded "><a href="../cross-contract/working-with-time.html"><strong aria-hidden="true">5.4.</strong> Working with time</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Inter-blockchain communication</div></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../impressum.html">Legal Information</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CosmWasm book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="testing-a-query"><a class="header" href="#testing-a-query">Testing a query</a></h1>
<p>Last time we created a new query, now it is time to test it out. We will start with the basics -
the unit test. This approach is simple and doesn't require knowledge besides Rust. Go to the
<code>src/contract.rs</code> and add a test in its module:</p>
<pre><code class="language-rust noplayground"><span class="boring">use crate::msg::{GreetResp, QueryMsg};
</span><span class="boring">use cosmwasm_std::{
</span><span class="boring">    to_binary, Binary, Deps, DepsMut, Empty, Env, MessageInfo, Response, StdResult,
</span><span class="boring">};
</span><span class="boring">
</span><span class="boring">pub fn instantiate(
</span><span class="boring">    _deps: DepsMut,
</span><span class="boring">    _env: Env,
</span><span class="boring">    _info: MessageInfo,
</span><span class="boring">    _msg: Empty,
</span><span class="boring">) -&gt; StdResult&lt;Response&gt; {
</span><span class="boring">    Ok(Response::new())
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">pub fn query(_deps: Deps, _env: Env, msg: QueryMsg) -&gt; StdResult&lt;Binary&gt; {
</span><span class="boring">    use QueryMsg::*;
</span><span class="boring">
</span><span class="boring">    match msg {
</span><span class="boring">        Greet {} =&gt; to_binary(&amp;query::greet()?),
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">mod query {
</span><span class="boring">    use super::*;
</span><span class="boring">
</span><span class="boring">    pub fn greet() -&gt; StdResult&lt;GreetResp&gt; {
</span><span class="boring">        let resp = GreetResp {
</span><span class="boring">            message: &quot;Hello World&quot;.to_owned(),
</span><span class="boring">        };
</span><span class="boring">
</span><span class="boring">        Ok(resp)
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span>#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn greet_query() {
        let resp = query::greet().unwrap();
        assert_eq!(
            resp,
            GreetResp {
                message: &quot;Hello World&quot;.to_owned()
            }
        );
    }
}
</code></pre>
<p>If you ever wrote a unit test in Rust, nothing should surprise you here. Just a
simple test-only module contains local function unit tests. The problem is - this
test doesn't build yet. We need to tweak our message types a bit. Update the <code>src/msg.rs</code>:</p>
<pre><code class="language-rust noplayground"><span class="boring">use serde::{Deserialize, Serialize};
</span><span class="boring">
</span>#[derive(Serialize, Deserialize, PartialEq, Debug, Clone)]
pub struct GreetResp {
    pub message: String,
}

#[derive(Serialize, Deserialize, PartialEq, Debug, Clone)]
pub enum QueryMsg {
    Greet {},
}
</code></pre>
<p>I added three new derives to both message types. <a href="https://doc.rust-lang.org/std/cmp/trait.PartialEq.html"><code>PartialEq</code></a>
is required to allow comparing types
for equality - so we can check if they are equal. The <a href="https://doc.rust-lang.org/std/fmt/trait.Debug.html"><code>Debug</code></a>
is a trait generating debug-printing
utilities. It is used by <a href="https://doc.rust-lang.org/std/macro.assert_eq.html"><code>assert_eq!</code></a> to
display information about mismatch if an assertion
fails. Note that because we are not testing the <code>QueryMsg</code> in any way, the additional trait derives
are optional. Still, it is a good practice to make all messages both <code>PartialEq</code> and <code>Debug</code> for
testability and consistency.
The last one, <a href="https://doc.rust-lang.org/std/clone/trait.Clone.html"><code>Clone</code></a> is not needed for now yet,
but it is also good practice to allow messages to be cloned around. We will also require that
later, so I added it already not to go back and forth.</p>
<p>Now we are ready to run our test:</p>
<pre><code>$ cargo test

...
running 1 test
test contract::tests::greet_query ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
</code></pre>
<p>Yay! Test passed!</p>
<h2 id="contract-as-a-black-box"><a class="header" href="#contract-as-a-black-box">Contract as a black box</a></h2>
<p>Now let's go a step further. The Rust testing utility is a friendly tool for building even higher-level
tests. We are currently testing smart contract internals, but if you think about how your smart contract
is visible from the outside world. It is a single entity that is triggered by some input messages. We can
create tests that treat the whole contract as a black box by testing it via our <code>query</code> function. Let's
update our test:</p>
<pre><code class="language-rust noplayground"><span class="boring">use crate::msg::{GreetResp, QueryMsg};
</span><span class="boring">use cosmwasm_std::{
</span><span class="boring">    to_binary, Binary, Deps, DepsMut, Empty, Env, MessageInfo, Response, StdResult,
</span><span class="boring">};
</span><span class="boring">
</span><span class="boring">pub fn instantiate(
</span><span class="boring">    _deps: DepsMut,
</span><span class="boring">    _env: Env,
</span><span class="boring">    _info: MessageInfo,
</span><span class="boring">    _msg: Empty,
</span><span class="boring">) -&gt; StdResult&lt;Response&gt; {
</span><span class="boring">    Ok(Response::new())
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">pub fn query(_deps: Deps, _env: Env, msg: QueryMsg) -&gt; StdResult&lt;Binary&gt; {
</span><span class="boring">    use QueryMsg::*;
</span><span class="boring">
</span><span class="boring">    match msg {
</span><span class="boring">        Greet {} =&gt; to_binary(&amp;query::greet()?),
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">mod query {
</span><span class="boring">    use super::*;
</span><span class="boring">
</span><span class="boring">    pub fn greet() -&gt; StdResult&lt;GreetResp&gt; {
</span><span class="boring">        let resp = GreetResp {
</span><span class="boring">            message: &quot;Hello World&quot;.to_owned(),
</span><span class="boring">        };
</span><span class="boring">
</span><span class="boring">        Ok(resp)
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span>#[cfg(test)]
mod tests {
    use cosmwasm_std::from_binary;
    use cosmwasm_std::testing::{mock_dependencies, mock_env};

    use super::*;

    #[test]
    fn greet_query() {
        let resp = query(
            mock_dependencies().as_ref(),
            mock_env(),
            QueryMsg::Greet {}
        ).unwrap();
        let resp: GreetResp = from_binary(&amp;resp).unwrap();

        assert_eq!(
            resp,
            GreetResp {
                message: &quot;Hello World&quot;.to_owned()
            }
        );
    }
}
</code></pre>
<p>We needed to produce two entities for the <code>query</code> functions: the <code>deps</code> and <code>env</code> instances.
Fortunately, <code>cosmwasm-std</code> provides utilities for testing those -
<a href="https://docs.rs/cosmwasm-std/1.0.0/cosmwasm_std/testing/fn.mock_dependencies.html"><code>mock_dependencies</code></a>
and <a href="https://docs.rs/cosmwasm-std/1.0.0/cosmwasm_std/testing/fn.mock_env.html"><code>mock_env</code></a>
functions.</p>
<p>You may notice the dependencies mock of a type
<a href="https://docs.rs/cosmwasm-std/1.0.0/cosmwasm_std/struct.OwnedDeps.html"><code>OwnedDeps</code></a> instead
of <code>Deps</code>, which we need here - this is why the
<a href="https://docs.rs/cosmwasm-std/1.0.0/cosmwasm_std/struct.OwnedDeps.html#method.as_ref"><code>as_ref</code></a>
function is called on it. If we looked for a <code>DepsMut</code> object, we would use
<a href="https://docs.rs/cosmwasm-std/1.0.0/cosmwasm_std/struct.OwnedDeps.html#method.as_mut"><code>as_mut</code></a>
instead.</p>
<p>We can rerun the test, and it should still pass. But when we think about that test reflecting
the actual use case, it is inaccurate. The contract is queried, but it was never instantiated!
In software engineering, it is equivalent to calling a getter without constructing an object -
taking it out of nowhere. It is a lousy testing approach. We can do better:</p>
<pre><code class="language-rust noplayground">
<span class="boring">use crate::msg::{GreetResp, QueryMsg};
</span><span class="boring">use cosmwasm_std::{
</span><span class="boring">    to_binary, Binary, Deps, DepsMut, Empty, Env, MessageInfo, Response, StdResult,
</span><span class="boring">};
</span><span class="boring">
</span><span class="boring">pub fn instantiate(
</span><span class="boring">    _deps: DepsMut,
</span><span class="boring">    _env: Env,
</span><span class="boring">    _info: MessageInfo,
</span><span class="boring">    _msg: Empty,
</span><span class="boring">) -&gt; StdResult&lt;Response&gt; {
</span><span class="boring">    Ok(Response::new())
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">pub fn query(_deps: Deps, _env: Env, msg: QueryMsg) -&gt; StdResult&lt;Binary&gt; {
</span><span class="boring">    use QueryMsg::*;
</span><span class="boring">
</span><span class="boring">    match msg {
</span><span class="boring">        Greet {} =&gt; to_binary(&amp;query::greet()?),
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">mod query {
</span><span class="boring">    use super::*;
</span><span class="boring">
</span><span class="boring">    pub fn greet() -&gt; StdResult&lt;GreetResp&gt; {
</span><span class="boring">        let resp = GreetResp {
</span><span class="boring">            message: &quot;Hello World&quot;.to_owned(),
</span><span class="boring">        };
</span><span class="boring">
</span><span class="boring">        Ok(resp)
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span>#[cfg(test)]
mod tests {
    use cosmwasm_std::from_binary;
    use cosmwasm_std::testing::{mock_dependencies, mock_env, mock_info};

    use super::*;

    #[test]
    fn greet_query() {
        let mut deps = mock_dependencies();
        let env = mock_env();

        instantiate(
            deps.as_mut(),
            env.clone(),
            mock_info(&quot;sender&quot;, &amp;[]),
            Empty {},
        )
        .unwrap();

        let resp = query(deps.as_ref(), env, QueryMsg::Greet {}).unwrap();
        let resp: GreetResp = from_binary(&amp;resp).unwrap();
        assert_eq!(
            resp,
            GreetResp {
                message: &quot;Hello World&quot;.to_owned()
            }
        );
    }
}
</code></pre>
<p>A couple of new things here. First, I extracted the <code>deps</code> and <code>env</code> variables to their variables
and passed them to calls. The idea is that those variables represent some blockchain persistent state,
and we don't want to create them for every call. We want any changes to the contract state occurring
in <code>instantiate</code> to be visible in the <code>query</code>. Also, we want to control how the environment differs
on the query and instantiation.</p>
<p>The <code>info</code> argument is another story. The message info is unique for each message sent. To create the
<code>info</code> mock, we must pass two arguments to the
<a href="https://docs.rs/cosmwasm-std/1.0.0/cosmwasm_std/testing/fn.mock_info.html"><code>mock_info</code></a> function.</p>
<p>First is the address performing a call. It may look strange to pass <code>sender</code> as an address instead of some
mysterious <code>wasm</code> followed by hash, but it is a valid address. For testing purposes, such addresses are
typically better, as they are way more verbose in case of failing tests.</p>
<p>The second argument is funds sent with the message. For now, we leave it as an empty slice, as I don't want
to talk about token transfers yet - we will cover it later.</p>
<p>So now it is more a real-case scenario. I see just one problem. I say that the contract is a single black
box. But here, nothing connects the <code>instantiate</code> call to the corresponding <code>query</code>. It seems that we assume
there is some global contract. But it seems that if we would like to have two contracts instantiated differently
in a single test case, it would become a mess. If only there would be some tool to abstract this for us, wouldn't
it be nice?</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../basics/query.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../basics/multitest-intro.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../basics/query.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../basics/multitest-intro.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
